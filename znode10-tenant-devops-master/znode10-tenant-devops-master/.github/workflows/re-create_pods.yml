name: Re-creating Pods
on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Select Environment
        required: true
        options:
        - uat
        - etnadev
        - sandbox
        - trng

      select_env_path:
        type: choice
        description: Select Environment Path
        options:
        - tenants/uat
        - tenants/etna/dev
        - tenants/usds
        - tenants/trng

      choice:
        description: 'Send email notification?'
        type: choice
        options:
          - 'Yes'
          - 'No' 

jobs:
  deploy_build_on_aks_knox:
    name: Re-creating Pods
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with: 
          ref: master

      - name: Kubernetes Set up
        uses: azure/k8s-set-context@v1
        with:
          kubeconfig: ${{ secrets.KUBECONFIG }}
          version: '1.19.9'

      - name: delete znode pods
        working-directory: ${{ inputs.select_env_path }}
        run: kubectl delete -f deploy/app/pods  -n znode

      - name: create delete configmap
        working-directory: ${{ inputs.select_env_path }}
        run: |
          kubectl delete -f configmap -n znode
          kubectl create -f configmap -n znode

      - name: create znode pods
        working-directory: ${{ inputs.select_env_path }}
        run: kubectl create -f deploy/app/pods -n znode

  email_alerts:
    name: Send Email Notification
    runs-on: ubuntu-latest
    needs: deploy_build_on_aks_knox
    if: ${{ github.event.inputs.choice == 'Yes' }}
    steps:
      - name: Set Email Subject and Body
        id: set_email_content
        run: |
          STATUS=${{ job.status }}
          DEPLOYMENT_TIME=$(TZ='Asia/Kolkata' date +"%Y-%m-%d %H:%M:%S")
          if [ "${STATUS}" == "success" ]; then
            SUBJECT="Znode10 ${{ github.event.inputs.environment }} Build - *Success*"
            BODY="Hi Team,<br><font color='green'>The deployment status of Znode10 ${{ github.event.inputs.environment }} is done successfully.</font><br><br><b>Deployment Time:</b> ${DEPLOYMENT_TIME}"
          else
            SUBJECT="Znode10 ${{ github.event.inputs.environment }} Build - *Failed*"
            BODY="Hi Team,<br><font color='red'>The deployment status of Znode10 ${{ github.event.inputs.environment }} has failed.</font><br><br><b>Deployment Time:</b> ${DEPLOYMENT_TIME}"
          fi
          echo "subject=${SUBJECT}" >> $GITHUB_ENV
          echo "body=${BODY}" >> $GITHUB_ENV

      - name: Send Email
        env:
          EMAIL_TO: "znode-mission@mrrsoft.com"
          EMAIL_FROM: "tfsalert@amla.io"
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          TRIGGERED_BY: ${{ github.actor }}
          SUBJECT: ${{ env.subject }}
          BODY: ${{ env.body }}
        run: |
          IFS=',' read -r -a EMAIL_ARRAY <<< "${EMAIL_TO}"
          BODY="${BODY} <br>This build was triggered by: ${TRIGGERED_BY}."
          for EMAIL in "${EMAIL_ARRAY[@]}"; do
            echo "Sending email to ${EMAIL}"  # Debug statement
            echo -e "Subject:${SUBJECT}\nContent-Type: text/html\n\n${BODY}" | \
            curl --url 'smtps://smtp.gmail.com:465' --ssl-reqd \
              --mail-from "${EMAIL_FROM}" --mail-rcpt "${EMAIL}" \
              --user "${EMAIL_FROM}:${EMAIL_PASSWORD}" \
              --upload-file -
          done



